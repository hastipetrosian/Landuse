---
#title: "Cross validation"
---

```{r {r package}}
library(blockCV)
library(sf)
library(raster)
source("functions.R")
library(ggplot2)
library(shiny)
```

```{r input_data}
## increase memory
if (.Platform$OS.type=="windows") memory.limit(1000000)

## get all data (as tables of x,y, predictors, change)
load("rr_points14.RData")

## test with smaller data set
dat <- filter(rr_points14[["2014"]],
              x<604000 & y >284000 &  y < 2846000)
dat$change2 <- change_fun(dat$change)
```

```{r}
dat_gain <- filter(dat, change %in% c("no gain", "gain")) 

## analyzing gain only, first ...
if (file.exists("dat_upsample")) {load("dat_upsample")
} else {
dat_upsample <- ovun.sample(change ~ ., data = dat_gain, method = "both", N=1500)$data
}
```
classified maps
```{r classified_maps}
classified1=raster("Classified1.tif")
classified2=raster("classified2.tif")
```
make a SpatialPointsDataFrame object from data.frame
```{r numeric_data}
## PA=as.numeric(dat$change2)
PA_data <- st_as_sf(dat_upsample, coords = c("x", "y"), crs = crs(classified1))
##PA=as.factor(dat$change2)
```
spatial blocking by specified range with random assignment
```{r}
if (file.exists("sb.RData")){load("sb.RData")
} else {
sb <- spatialBlock(speciesData = PA_data,
                   species = "change2",
                   rasterLayer = classified1,
                   ## theRange = 70000, # size of the blocks
                   theRange = 5000, # size of the blocks                   
                   k = 5,
                   selection = "random",
                   iteration = 100, # find evenly dispersed folds
                   biomod2Format = TRUE,
                   xOffset = 0, # shift the blocks horizontally
                   yOffset = 0)
}

traincontrolsb=trainControl(index = sb,method="CV")
```

```{r}
eb <- envBlock(rasterLayer = classified1,
               speciesData = PA_data,
               species = "change2",
               k = 5,
               standardization = "standard", # rescale variables between 0 and 1
               rasterBlock = FALSE,
               numLimit = 50)
traincontroleb=trainControl(index = eb,method="CV")
```
H-p:error  `index` should be lists of integers.
```{r random_forest}
rf_fit4=train(as.factor(change2) ~ ., data = sample_train,
          method = "ranger",
          trControl = traincontrolsb)
rf_pred4 <- predict(rf_fit4, sample_test)
con4=confusionMatrix(rf_pred4, as.factor(sample_test$change2))
```
adding points on saptialBlock plot
```{r plot}
sb$plots + geom_sf(data = PA_data, alpha = 0.5)
```
visualising the generated folds on a map
```{r folds_in_spatialk}
fold=foldExplorer(eb, classified1, PA_data)
```

